<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/neon-animation/animations/transform-animation.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="gnc-about.html">
<link rel="import" href="gnc-icons.html">
<link rel="import" href="gnc-issue-viewer.html">
<link rel="import" href="gnc-kpi-detail.html">
<link rel="import" href="gnc-modal-page.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="sync-get.html">

<link rel="lazy-import" href="gnc-scenario.html">
<link rel="lazy-import" href="gnc-terms-and-conditions.html">
<link rel="lazy-import" href="gnc-privacy-statement.html">
<link rel="lazy-import" href="gnc-welcome.html">
<link rel="lazy-import" href="gnc-view404.html">

<dom-module id="gnc-app">
	<template>
		<style include="shared-styles">
			:host {
				--app-drawer-width: 220px;
				--app-menu-color: #fafbfc;
				--app-selected-menu: #1f3a4f;
				display: block;
			}
			.logo {
				margin: auto;
				padding: 0;
				width: 140px;
			}
			.logo img {
				width: 100%;
			}
			.logo-toolbar {
				margin: 14px 0 0 0;
				height: 30px;
			}
			app-drawer-layout:not([narrow]) [drawer-toggle] {
				display: none;
			}
			app-header {
				color: var(--app-primary-color);
				background-color: var(--app-menu-color);
				height: 74px;
			}
			app-toolbar {
				padding-top: 10px;
			}
			iron-selector a:last-child {
				border-bottom: 1px #4e7593 solid;
			}
			gnc-modal-page {
				width: 100%;
				top: 30px;
				background-color: var(--app-palegrey-color);
				height: 100%;
			}
			.dialog-close {
				float: right;
				top: 10px;
				font-size: 16px;
				color: var(--app-primary-color);
			}
			.drawer-list a {
				display: block;
				padding: 16px;
				text-decoration: none;
				color: var(--app-menu-color);
				background: var(--app-primary-color);
				line-height: 40px;
				font-size: 15px;
				outline: 0;
			}
			.drawer-list a.iron-selected {
				background: var(--app-selected-menu)
			}
			.fill {
				height: 100%;
				width: 100%;
				background: var(--app-primary-color);
			}
			@media screen and (min-width: 768px) {
				paper-button {
					font-size: var(--app-font-size);
				}
			}
			.hide {
				visibility: hidden;
			}
		</style>

		<app-location
			route="{{route}}"
			url-space-regex="^[[rootPath]]">
		</app-location>

		<app-route
			route="{{route}}"
			pattern="[[rootPath]]:page"
			data="{{routeData}}"
			tail="{{subroute}}">
		</app-route>

		<app-drawer-layout fullbleed responsive-width="4095px">
			<app-header-layout>
				<app-header id="header" slot="header">
					<app-toolbar>
						<a href="/scenario">
							<img src="/images/logo.svg" alt="Growth-Navigator logo" class="logo-toolbar cursor-pointer">
						</a>
						<div main-title></div>
						<paper-icon-button icon="gnc-icons:bell" on-click="_openAboutDialog"></paper-icon-button>
						<template is="dom-if" if="[[ !signedIn ]]">
							<paper-button on-click="_signInClicked">sign in / sign up</paper-button>
						</template>
						<template is="dom-if" if="[[ signedIn ]]">
							<paper-button on-click="_signInClicked">Sign out [[ username ]]</paper-button>
						</template>
					</app-toolbar>
				</app-header>
				<iron-pages
					id="pages"
					selected="[[page]]"
					attr-for-selected="name"
					fallback-selection="view404"
					role="main"
					on-gnc-issue-selected="_onIssueSelected">
					<gnc-current name="current" on-rpc-error="_onRpcError"></gnc-current>
					<gnc-scenario name="scenario" on-zoom-changed="_onZoomChanged" on-rpc-error="_onRpcError"></gnc-scenario>
					<gnc-terms-and-conditions name="terms-and-conditions"></gnc-terms-and-conditions>
					<gnc-privacy-statement name="privacy-statement"></gnc-privacy-statement>
					<gnc-welcome name="welcome"></gnc-welcome>
					<gnc-view404 name="view404"></gnc-view404>
				</iron-pages>
			</app-header-layout>
		</app-drawer-layout>

		<gnc-modal-page id="dialogAbout" class="size-position" modal role="alertdialog">
			<div class="dialog-close">
				<paper-icon-button dialog-confirm autofocus icon="gnc-icons:close"></paper-icon-button>
			</div>
			<gnc-about></gnc-about>
		</gnc-modal-page>
		<sync-get id="syncget"></sync-get>
	</template>

	<script>

		Polymer.setPassiveTouchGestures(true);

		class GncApp extends Polymer.Element {
			static get is() {
				return 'gnc-app';
			}
			static get properties() {
				return {
					auth: {
						type: Object,
						value: () => ({})
					},
					signedIn: Boolean,
					username: String,

					properties: {
						type: Object,
						computed: '_computeData()',
					},

					page: {
						type: String,
						reflectToAttribute: true,
						observer: '_pageChanged',
					},
					routeData: Object,
					subroute: Object,
					// This shouldn't be neccessary, but the Analyzer isn't picking up
					// Polymer.Element#rootPath
					rootPath: String
				};
			}
			static get observers() {
				return [
					'_routePageChanged(routeData.page)',
				];
			}
			ready() {
				super.ready();
				this.signedIn = false;
				AWS.config.region = this.properties['gnc.region'];

				const authData = {
					TokenScopesArray: [],
					IdentityProvider: 'COGNITO',
					AdvancedSecurityDataCollectionFlag: false,

					ClientId: this.properties['clientId'],
					AppWebDomain: this.properties['appWebDomain'],
					RedirectUriSignIn: this.properties['redirectUriSignIn'],
					RedirectUriSignOut: this.properties['redirectUriSignOut'],
					UserPoolId: this.properties['userPoolId'],
				};
				this.auth = new AmazonCognitoIdentity.CognitoAuth(authData);
				this.auth.userhandler = {
					onSuccess: session => {
						var idToken = session.getIdToken().getJwtToken();
						this.signedIn = true;
						localStorage.setItem('X-ID-Token', idToken);
						this.page = 'scenario';
						window.history.pushState('Current situation', 'Current', '/scenario');
					},
					onFailure: err => {
						console.log("ON FAILURE: " + err);
						this.signedIn = false;
						localStorage.setItem('X-ID-Token', '');
						location.href = '/welcome';
						window.history.pushState('Growth-Navigator', 'Welcome', '/welcome');
					}
				};
				this.auth.useCodeGrantFlow();
				if (this.auth.getCachedSession().isValid()) {
					this.signedIn = true;
					const href = window.location.href;
					const page = href.substring(href.lastIndexOf('/') + 1);

					if (!page) {
						this.page = 'scenario';
					}
					window.history.pushState('Growth-Navigator', 'Welcome', '/' + this.page);
				}
				var curUrl = window.location.href;
				this.auth.parseCognitoWebResponse(curUrl);
			}
			_routePageChanged(page) {
				// console.log('idToken', localStorage.getItem('X-ID-Token'));
				this.page = page || 'welcome';
			}
			_openAboutDialog(ev) {
				ev.preventDefault();
				this.$.dialogAbout.toggle();
			}
			_pageChanged(page) {
				// Load page import on demand. Show 404 page if fails
				const resolvedPageUrl = this.resolveUrl('gnc-' + page + '.html');
				Polymer.importHref(
					resolvedPageUrl,
					null,
					this._showPage404.bind(this),
					true);
			}
			_showPage404() {
				this.page = 'view404';
			}
			_onZoomChanged(ev) {
				this.$.header.setAttribute('class', ev.detail ? 'hide' : '');
				const p = this.username && this.username.substring(0, 2);
				const n = 'panel: ' + ev.detail;
				window.dataLayer.push({ event: 'zoom', n, p, ts: Date.now() });
			}
			_computeData() {
				var response = '';
				this.$.syncget.getResource({
					url: 'properties.json',
					onLoad(e) {
						response = JSON.parse(e.target.responseText);
					}
				});
				Object.keys(response).forEach(key => {
					localStorage.setItem('gnc.' + key, response[key]);
				});
				return response;
			}
			_onRpcError(ev) {
				ev.preventDefault();
				if (ev.detail && ev.detail.code === -32021) {
					this.page = 'terms-and-conditions';
					window.history.pushState('Growth-Navigator terms and conditions of use', 'TsAndCs', '/terms-and-conditions');
				} else {
					this.page = 'welcome';
					window.history.pushState('Welcome', 'Welcome', '/welcome');
				}
			}
			_userSignedIn(ev) {
				this.page = 'scenario';
			}
			_signInClicked(ev) {
				const userkey = 'CognitoIdentityServiceProvider.' + this.properties['clientId'] + '.LastAuthUser';
				if (this.signedIn) {
					this.auth.signOut();
					this.signedIn = false;
					this.username = '';
					localStorage.setItem('X-ID-Token', '');
				} else {
					// get current or new auth session
					this.auth.getSession();
				}
			}
		}

		window.customElements.define(GncApp.is, GncApp);
	</script>
</dom-module>
