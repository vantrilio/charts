<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/google-chart/google-chart.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<dom-module id="gnc-liquidity-graph">
	<template>
		<style>
		:host {
			display: block;
		}
		google-chart {
			height: 400px;
		}
		</style>
		<!-- <template is="dom-if" if="[[ showGraph ]]"> -->
			<google-chart
				id="graph"
				options="[[ options ]]"
				cols="[[ cols ]]"
				rows="[[ rows ]]"
				events=' [ "select" ]'
				style$="[[ graphStyle ]]"
				on-google-chart-select="_onGoogleChartSelect">
			</google-chart>
		<!-- </template> -->
	</template>

	<script>
		var timeout;

		class GncLiquidityGraph extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior],
			Polymer.MutableData(Polymer.Element)) {
			static get is() {
				return 'gnc-liquidity-graph';
			}
			static get properties() {
				return {
					// attributes
					header: Object,
					graphData: Object,
					seriesLabel: String,
					yLabel: String,
					ts: Number,

					// computed properties
					cols: Array,
					rows: Array,
					graphStyle: String,
					showGraph: Boolean,
					options: Object
				}
			}
			static get observers() {
				return [
					'_graphDataChanged(graphData, seriesLabel, ts)'
				];
			}
			connectedCallback() {
				super.connectedCallback();
				this.addEventListener("iron-resize", (ev) => {
					if (timeout) {
						Polymer.Async.timeOut.cancel(timeout);
					}
					timeout = Polymer.Async.timeOut.run(() => {
						this.graphStyle = 'width: ' + 40 + 'px';
						this.$.graph.redraw();
						this.graphStyle = 'width: ' + this.offsetWidth + 'px';
						this.$.graph.redraw();
					}, 200);
				});
			}
			ready() {
				this.graphStyle = 'width: 100%';
				this.cols = [{"label": "", "type": "string"}];
				// https://developers.google.com/chart/interactive/docs/gallery/combochart
				this.options = {
					title : '',
				    vAxis: {
						title: this.yLabel,
						titleTextStyle: {
							color: '#2e5573',
							fontName: 'Open Sans'
						},
						textStyle: {
							color: '#2e5573',
		                	fontName: 'Open Sans'
						}
					},
				    hAxis: {
						title: '',
						titleTextStyle: {
							color: '#2e5573',
							fontName: 'Open Sans'
						},
						textStyle: {
							color: '#2e5573',
		                	fontName: 'Open Sans'
						}
					},

				    seriesType: 'bars',
				    series: {},
					legend: {
						position: 'right',
						textStyle: {
							color: '#2e5573',
		                	fontName: 'Open Sans'
						}
					},
					bar: {
						groupWidth: "90%"
					},
					isStacked: true,
					animation: {
						duration: 400
					}
				};
				super.ready();
				if (!this.header) {
					return;
				}
				this.options.series = this.header.map((head) => {
					const res = {};

					this.cols.push({
						label: head.label,
						type: "number"
					});
					if (head.plotType === 'line') {
						res.type = 'line';
					} else if (head.plotType === 'lineDash') {
						res.type = 'line';
						res.lineDashStyle = [4, 4];
					}
					if (head.color) {
						res.color = head.color;
					}
					return res;
				});

			}
			_graphDataChanged(graphData, seriesLabel, ts) {
				this.rows = this._rowData(this.graphData);
				this.options.hAxis.title = this.seriesLabel;
				this.showGraph = this.header && this.graphData && this.seriesLabel && this.yLabel;
			}
			_rowData(dataObj) {
				if (!dataObj || typeof dataObj[this.header[0].key] !== 'object') {
					return [];
				}
				if (!this.header) {
					return [];
				}
				const rowData = [];
				const firstDataRowLength = dataObj[this.header[0].key].length;
				for (var i = 0; i < firstDataRowLength; i++) {
					const point = ['' + i]; // x-axis label
					this.header.forEach((head, idx) => {
						point.push(dataObj[this.header[idx].key][i]);
					});
					rowData.push(point);
				}
				return rowData;
			}
			_onGoogleChartSelect(ev) {
				const graphObj = ev.detail.chart;
				const coordinate = graphObj.getSelection()[0];
				if (!this.dispatchEvent(new CustomEvent('coordinate-selected', {detail: {coordinate}}))) {
					graphObj.setSelection([]);
				}
			}
		}
		window.customElements.define(GncLiquidityGraph.is, GncLiquidityGraph);
	</script>
</dom-module>
